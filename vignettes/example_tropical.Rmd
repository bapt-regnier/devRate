---
title: "Using devRate package on T. solanivora (Lepidoptera: Gelechiidae) in Ecuador"
author: "Francois Rebaudo, using data from Crespo-Perez et al. 2011"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{main}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette exemplifies the use of the devRate package to fit a development rate 
model to an empirical dataset (laboratory experiments at air constant temperatures) 
and to build a simple phenological model.

## T. solanivora dataset
The dataset for T. solanivora was retrieved from Crespo-Perez et al.
2011^[Crespo-Pérez, V., Rebaudo, F., Silvain, J.-F. and Dangles, O. (2011)
      Modeling invasive species spread in complex landscapes: the case of
      potato moth in Ecuador. Landscape Ecology, 26, 1447–1461.], using Web
Plot Digitizer^[Rohatgi, A. (2015) WebPlotDigitalizer: HTML5 Based Online Tool
                to Extract Numerical Data from Plot Images.]. The dataset is 
also included in the package in the exTropicalMoth object which is a list of the 
raw data presented below (a list of three elements for eggs, larva, and pupa), and a 
list of the NLS fit to the Taylor model (taylor_81; a list of three elements  for 
eggs, larva, and pupa).

```{r}
## Experimental temperatures and development rate for the eggs
expeTempEggs <- c(10.0, 10.0, 15.0, 15.0, 15.5, 13.0, 16.0, 16.0, 17.0, 20.0, 20.0, 
              25.0, 25.0, 30.0, 30.0, 35.0)
expeDevEggs <- c(0.031, 0.039, 0.047, 0.059, 0.066, 0.072, 0.083, 0.1, 0.1, 0.1, 0.143, 
             0.171, 0.2, 0.2, 0.18, 0.001)
rawDevEggs <- matrix(c(expeTempEggs, expeDevEggs), ncol = 2)

## Experimental temperatures and development rate for the larva
expeTempLarva <- c(10.0, 10.0, 10.0, 13.0, 15.0, 15.5, 15.5, 15.5, 17.0, 20.0, 25.0, 
                   25.0, 30.0, 35.0)
expeDevLarva <- c(0.01, 0.014, 0.019, 0.034, 0.024, 0.029, 0.034, 0.039, 0.067, 0.05, 
                  0.076, 0.056, 0.0003, 0.0002)
rawDevLarva <- matrix(c(expeTempLarva, expeDevLarva), ncol = 2)

## Experimental temperatures and development rate for the pupa
expeTempPupa <- c(10.0, 10.0, 10.0, 13.0, 15.0, 15.0, 15.5, 15.5, 16.0, 16.0, 17.0, 
                  20.0, 20.0, 25.0, 25.0, 30.0, 35.0)
expeDevPupa <- c(0.001, 0.008, 0.012, 0.044, 0.017, 0.044, 0.017, 0.044, 0.039, 0.034, 
                 0.037, 0.051, 0.051, 0.08, 0.092, 0.102, 0.073, 0.005, 0.0002)
rawDevPupa <- matrix(c(expeTempPupa, expeDevPupa), ncol = 2)

## Same dataset included in the package
library("devRate")
data(exTropicalMoth)
str(exTropicalMoth[[1]])
```

## Finding models in the literature
Before attempting to fit any model to the empirical data, the devRate function
"devRateFind" search the database for previous articles fitting which models to
the organism, either by Order, Family, or species. The most used models are
presented at the top of the data.frame.

```{r}
devRateFind(orderSP = "Lepidoptera")
```
    
Here we can see that at the time of thie vignette, campbell_74 model was used 
108 times to characterize the relationship between development rate and temperature 
for the Lepidoptera Order, and the taylor_81 model 22 times.

```{r}
devRateFind(familySP = "Gelechiidae")
```

If we focus on the Family (Gelechiidae), campbell_74 has been used 12 times, and
taylor_81 2 times.

```{r}
devRateFind(species = "Tecia solanivora")
```

Unfortunately, the species Tecia solanivora is not in the package database, so 
that we have to find a closely-related species.

The "devRateInfo" function provides additional information on these models
and on parameter estimations.

```{r}
devRateInfo(eq = taylor_81)
```

Here we can see that Symmetrischema tangolias study by Sporleder et al. 2016 has 
used the taylor_81 model. 

Information from the database can be plotted using the "devRatePlotInfo" function 
if we want to have a first look on the taylor_81 model.

```{r, fig.width = 6, fig.height = 6}
devRatePlotInfo (eq = taylor_81, sortBy = "ordersp",
  ylim = c(0, 0.20), xlim = c(0, 50))
```

## Fitting models to empirical datasets
Now that we have a model candidate and starting parameter estimates from a 
closely-related species, we can start the fitting process with our empirical 
data (NLS fit). The empirical data can be fitted to any model in the database 
with the "devRateModel" function, which returns an object of class "nls".

```{r}
mEggs <- devRateModel(eq = taylor_81, 
  temp = exTropicalMoth$raw$eggs[,1], 
  devRate = exTropicalMoth$raw$eggs[,2],
  startValues = list(Rm = 0.05, Tm = 30, To = 5))
      
mLarva <- devRateModel(eq = taylor_81, 
  temp = exTropicalMoth$raw$larva[,1], 
  devRate = exTropicalMoth$raw$larva[,2],
  startValues = list(Rm = 0.05, Tm = 25, To = 10))
      
mPupa <- devRateModel(eq = taylor_81, 
  temp = exTropicalMoth$raw$pupa[,1], 
  devRate = exTropicalMoth$raw$pupa[,2],
  startValues = list(Rm = 0.1, Tm = 30, To = 10))
```
      
The summary of the "devRateModel" can be obtained with the "devRatePrint" function.

```{r}
devRatePrint(myNLS = mLarva, 
  temp = exTropicalMoth$raw$larva[,1], 
  devRate = exTropicalMoth$raw$larva[,2])
```

Empirical data can be plotted against the model using the "devRatePlot" function.

```{r, fig.width = 6, fig.height = 6}
devRatePlot(eq = taylor_81, 
  nlsDR = mEggs, 
  temp = exTropicalMoth$raw$eggs[,1], 
  devRate = exTropicalMoth$raw$eggs[,2],
  pch = 16, ylim = c(0, 0.2))
      
devRatePlot(eq = taylor_81, 
  nlsDR = mLarva, 
  temp = exTropicalMoth$raw$larva[,1], 
  devRate = exTropicalMoth$raw$larva[,2],
  pch = 16, ylim = c(0, 0.1))
      
devRatePlot(eq = taylor_81, 
  nlsDR = mPupa, 
  temp = exTropicalMoth$raw$pupa[,1], 
  devRate = exTropicalMoth$raw$pupa[,2],
  pch = 16, ylim = c(0, 0.15))
```

## Forecasting phenologies from empirical temperature
From the "nls" object obtained above, we can build a simple phenology model using 
temperature time series (e.g., to forecast the organism outbreaks).
In this example the temperature dataset is built from a Normal distribution of mean
15 and a standard deviation of 1, with a time step of one day. The development
models used are those previously fitted with the Taylor model for the three stages.
We assumed that the average time for female adults to lay eggs was of 1 day. We
simulated 500 individuals, with a stochasticity in development rate centered on
the development rate, with a standard deviation of 0.015 (Normal distribution).

```{r}
forecastTsolanivora <- devRateIBM(
  tempTS = rnorm(n = 100, mean = 15, sd = 1),
  timeStepTS = 1,
  models = list(mEggs, mLarva, mPupa),
  numInd = 50,
  stocha = 0.015,
  timeLayEggs = 1)
print(forecastTsolanivora)
```

Results can be plotted using the "devRateIBMPlot" function. From this simple 
model we can observe that if eggs of the first generation are laid at time t = 0, 
adults should be seen at t = [65:85], if the temperature time series correspond 
to the temperatures experienced by the organism and in the absence of other 
limiting factors.

```{r, fig.width = 6, fig.height = 6}
devRateIBMPlot(ibm = forecastTsolanivora, typeG = "density")
```
